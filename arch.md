# Stock Uploader - Архитектура проекта

## Обзор

Stock Uploader - автоматизированная система для генерации фотографий с использованием AI и загрузки на Adobe Stock.

## Архитектурные принципы

### Правило 5-300-20-3
- ≤5 параметров у функции
- ≤300 строк на файл
- ≤20 строк на метод
- ≤3 уровня вложенности

### Feature-based структура
Каждая фича изолирована в отдельной папке с собственными компонентами, сервисами и логикой.

## Структура проекта

```
StockUploader/
├── arch.md                       # Документация архитектуры
├── README.md                     # Общее описание проекта
├── database/
│   └── schema.sql                # SQL схема (выполняется вручную)
├── Instruction/                  # Существующие инструкции
│   ├── LLM/Gemeni.txt
│   ├── Image Generation Model/
│   └── Upscale/
│
├── web/                          # Cloudflare Pages
│   ├── prompts/
│   │   └── system-prompt.json
│   ├── package.json
│   ├── vite.config.ts
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   └── main.tsx
│   └── functions/
│       └── api/
│           ├── topics.ts
│           ├── adobe-settings.ts
│           └── trigger-worker.ts
│
└── worker/                       # GitHub Actions
    ├── prompts/
    │   └── system-prompt.json
    ├── package.json
    └── src/
        ├── main.ts
        └── services/
```

## Компоненты системы

### 1. Frontend (web/)
**Технологии**: React, Vite, TailwindCSS
**Деплой**: Cloudflare Pages
**Назначение**: Пользовательский интерфейс для управления темами и настройками

**Основные функции**:
- Просмотр списка тем со статусами
  - Отображение количества загруженных фотографий
  - Дата создания и дата загрузки
- Добавление новых тем с параметрами:
  - Название темы
  - Количество фотографий
  - Модель генерации (Flux/Imagen4)
  - Модель Upscale (Flux Vision/SeedVR)
- Управление настройками Adobe Stock API и SFTP
- Ручной запуск worker:
  - Кнопка "Run Worker Now" для немедленного запуска обработки
  - Отображение статуса запуска
  - Не влияет на автоматическое расписание

**API Endpoints** (Cloudflare Functions):
- `GET/POST /api/topics` - управление темами
- `GET/POST /api/adobe-settings` - настройки Adobe Stock (OAuth2 + SFTP)
- `POST /api/trigger-worker` - немедленный запуск worker через GitHub API

### 2. Worker (worker/)
**Технологии**: TypeScript, Node.js
**Выполнение**: GitHub Actions
**Назначение**: Автоматическая обработка тем и генерация изображений

**Workflow**:
1. **Проверка SFTP credentials** (обязательно, worker не запустится без них)
2. Получение темы со статусом 'new' из БД
3. Генерация промптов через Gemini
4. Для каждого изображения: выбор случайного соотношения сторон
5. Генерация изображений через Flux/Imagen4 с выбранным соотношением
6. Upscale изображений
7. Встраивание IPTC метаданных
8. Загрузка на Adobe Stock через SFTP (официальный метод с 2021 года)
9. Сохранение статистики загрузки (количество и дата)
10. Обновление статуса на 'done'

**Требования для запуска**:
- SFTP credentials должны быть настроены в веб-интерфейсе
- При отсутствии credentials worker завершается с сообщением об ошибке

**Сервисы**:
- `db.ts` - работа с базой данных
  - `updateUploadStats(id, count)` - сохранение статистики загрузки
- `llm/gemini.ts` - генерация промптов
- `image/{flux,imagen4}.ts` - генерация изображений
- `upscale/{flux-vision,seedvr}.ts` - апскейлинг
- `metadata/iptc.ts` - встраивание метаданных (piexifjs, без системных зависимостей)
- `adobe/auth.ts` - OAuth2 аутентификация для Adobe API
- `adobe/upload.ts` - загрузка на Adobe Stock через SFTP
  - Создание CSV файлов с метаданными
  - Загрузка изображений и CSV через SFTP
  - Retry логика и обработка ошибок
- `utils/aspect-ratio.ts` - рандомный выбор соотношения сторон в зависимости от модели

### 3. База данных
**Тип**: MySQL (внешний сервер)
**Доступ**: Оба компонента подключаются через `DB_URL`

**Таблицы**:
- `topics` - список тем для обработки
  - Включает статистику загрузки: `uploaded_count` (количество загруженных фото), `uploaded_at` (дата загрузки)
- `adobe_credentials` - учетные данные Adobe Stock
  - OAuth2 credentials: `client_id`, `client_secret`
  - SFTP credentials: `sftp_host`, `sftp_username`, `sftp_password`

### 4. Автоматизация
**Механизм**: GitHub Actions
**Расписание**: Ежедневно в 00:00 UTC
**Триггеры**: 
- cron schedule (автоматический)
- workflow_dispatch (ручной запуск через кнопку на сайте)

**Ручной запуск**:
- Кнопка "Run Worker Now" в интерфейсе управления темами
- Использует GitHub API для немедленного запуска workflow
- Не влияет на существующее cron расписание
- Требует настройки GitHub Personal Access Token

## Потоки данных

### Создание темы
```
Пользователь → Web UI → Cloudflare Function → MySQL → Статус: 'new'
```

### Обработка темы
```
GitHub Actions (cron) →
Worker → MySQL (получение темы) →
Gemini (промпты) →
Flux/Imagen4 (генерация) →
Upscale (улучшение) →
IPTC (метаданные) →
Adobe Stock (загрузка) →
MySQL (статус: 'done')
```

## Переменные окружения

### Web (Cloudflare Pages)
- `DB_URL` - строка подключения к MySQL
- `GITHUB_TOKEN` - Personal Access Token для запуска GitHub Actions
- `GITHUB_OWNER` - владелец GitHub репозитория (username или organization)
- `GITHUB_REPO` - название GitHub репозитория

### Worker (GitHub Secrets)
- `DB_URL` - строка подключения к MySQL
- `OPENROUTER_API_KEY` - ключ для Gemini API
- `FAL_KEY` - ключ для Flux/Imagen4/Upscale APIs

## Настройка GitHub Personal Access Token (PAT)

Для использования функции ручного запуска worker необходимо создать GitHub Personal Access Token:

### Создание токена

1. Откройте GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Нажмите "Generate new token (classic)"
3. Укажите описание: `StockUploader Worker Trigger`
4. Выберите срок действия (рекомендуется: No expiration или максимальный)
5. Выберите права доступа:
   - **Минимальный вариант**: `workflow` (только для запуска workflows)
   - **Расширенный вариант**: `repo` (полный доступ к репозиторию)
6. Нажмите "Generate token"
7. Скопируйте токен (он будет показан только один раз!)

### Добавление в Cloudflare Pages

1. Откройте Cloudflare Dashboard → Pages → выберите проект
2. Перейдите в Settings → Environment variables
3. Добавьте переменные:
   - `GITHUB_TOKEN` = ваш Personal Access Token
   - `GITHUB_OWNER` = владелец репозитория (например, `username`)
   - `GITHUB_REPO` = название репозитория (например, `StockUploader`)
4. Сохраните изменения
5. Выполните редеплой проекта для применения переменных

**Важно**: Храните токен в безопасности, не публикуйте его в коде или репозитории.

## Требования к изображениям (Adobe Stock)

- **Формат**: JPEG
- **Минимальное разрешение**: 1600×2400 пикселей (4 МП)
- **Качество**: Высокое, без артефактов
- **Соотношения сторон**: Система автоматически выбирает случайное соотношение для каждого изображения
  - Flux: 3:2, 16:9, 2:3, 9:16 (ориентированные на сток)
  - Imagen4: 16:9, 9:16, 4:3, 3:4 (доступные варианты модели)
- **Метаданные** (IPTC):
  - Title (заголовок)
  - Keywords (до 25 ключевых слов, первые 10 - приоритетные)
  - Description (описание)
  - Creator (опционально)
  - Copyright (опционально)

## Промпты для LLM

Системный промпт для генерации создан на основе best practices:
- Инструкции для реалистичных фото-промптов (камера, освещение, композиция)
- Правила создания ключевых слов для Adobe Stock
- Правила создания описаний

**Формат ответа Gemini**:
```json
{
  "prompt": "...",
  "title": "...",
  "keywords": ["...", "..."],
  "description": "..."
}
```

## Безопасность

- Учетные данные хранятся в переменных окружения
- Доступ к БД через SSL
- API ключи не хранятся в коде
- Adobe Stock credentials (OAuth2 + SFTP) в базе данных
- SFTP пароли хранятся в зашифрованном виде в БД

## Интеграция Adobe Stock через SFTP

### Метод загрузки

С июня 2021 года Adobe Stock использует **SFTP (SSH File Transfer Protocol)** в качестве основного метода загрузки контента от авторов.

### Процесс загрузки

1. **Получение SFTP credentials**
   - Войдите в Adobe Stock Contributor Portal
   - Перейдите: Submit → Upload Options → FTP/SFTP
   - Сгенерируйте новый SFTP пароль
   - Сохраните: Host, Username, Password

2. **Подключение к SFTP серверу**
   - Host: `sftp.contributor.adobestock.com`
   - Port: 22
   - Аутентификация: Username + Password
   - Протокол: SSH2 SFTP

3. **Загрузка файлов**
   - **Изображение**: JPEG файл (минимум 4 МП)
   - **Метаданные**: CSV файл с тем же именем

### Формат CSV метаданных

```csv
Filename,Title,Keywords,Category,Releases
image_1.jpg,"Sunset on tropical beach","sunset,beach,tropical,ocean,sky",,"No"
```

**Поля CSV**:
- `Filename` - имя файла изображения
- `Title` - заголовок (обязательно)
- `Keywords` - до 25 ключевых слов через запятую (обязательно)
- `Category` - категория Adobe Stock (опционально)
- `Releases` - наличие model/property releases ("Yes" или "No")

### Технические детали

**Библиотеки**: 
- `ssh2-sftp-client` (Node.js) - SFTP загрузка
- `piexifjs` - встраивание EXIF метаданных
**Retry логика**: 3 попытки с таймаутом 2 секунды
**Обработка ошибок**: Логирование и продолжение с следующим файлом

### Workflow загрузки (Пакетная загрузка)

**Оптимизация производительности**: Используется одно SFTP соединение для всех изображений темы.

```
Шаг 1-3 (для каждого изображения):
1. Генерация изображения → image_1.jpg, image_2.jpg, ...
2. Встраивание IPTC метаданных в каждый JPEG
3. Накопление в массиве для пакетной загрузки

Шаг 4 (пакетная загрузка всех файлов):
4. Подключение к SFTP серверу (ОДНО соединение)
5. Для каждого изображения в пакете:
   - Создание CSV файла
   - Загрузка JPEG
   - Загрузка CSV
   - Удаление локального CSV
6. Отключение от SFTP
7. Обновление счетчика uploadedCount

Преимущества:
- В 3 раза быстрее (20 изображений: ~30 секунд вместо ~90)
- Меньше нагрузка на SFTP сервер (1 подключение вместо 20)
- Более надежно (меньше точек отказа)
```

### Автоматическая обработка Adobe Stock

После загрузки через SFTP:
- Adobe Stock автоматически считывает метаданные из CSV
- Файлы проходят автоматическую проверку качества
- Изображения добавляются в очередь на модерацию
- После одобрения становятся доступны для покупки

## Масштабируемость

- Воркер обрабатывает по одной теме за запуск
- Можно увеличить частоту запусков GitHub Actions
- База данных поддерживает очередь тем
- Stateless архитектура позволяет горизонтальное масштабирование

## Логирование и мониторинг

### Архитектура логирования

Система использует структурированное логирование для отслеживания всех операций с внешними сервисами.

**Logger Utility** (`worker/src/utils/logger.ts`):
- `logStart(service, operation, params)` - начало операции
- `logSuccess(service, operation, duration, result)` - успешное завершение
- `logError(service, operation, error)` - ошибки
- `formatBytes(bytes)` - форматирование размеров файлов
- Автоматическая маскировка чувствительных данных (токены, пароли, секреты)

### Где смотреть логи

#### Worker (GitHub Actions)
1. Перейдите в репозиторий → вкладка **Actions**
2. Выберите нужный workflow run
3. Откройте job → просмотрите логи в консоли
4. Логи группируются по сервисам: `[SERVICE] Operation - STATUS (duration)`

#### Web Functions (Cloudflare Pages)
1. Cloudflare Dashboard → **Pages** → выбрать проект
2. Вкладка **Functions** → **Real-time logs**
3. Альтернатива: используйте `wrangler tail` из CLI
4. Формат логов: `[API_SERVICE] Operation - STATUS (duration)`

### Логируемые операции

#### База данных (DATABASE)
- Подключение к БД
- Получение темы (`getOldestNewTopic`)
- Обновление статуса темы (`updateTopicStatus`)
- Получение Adobe credentials (`getAdobeCredentials`)
- Закрытие соединения

#### Adobe Stock
- **ADOBE_AUTH**: получение OAuth2 access token (для API, если требуется)
- **ADOBE_UPLOAD**: загрузка через SFTP
  - Подключение к SFTP серверу Adobe Stock
  - Создание CSV файлов с метаданными
  - Загрузка JPEG файлов и CSV
  - Логируются: размеры файлов, имена файлов, статусы соединения

#### LLM (GEMINI)
- Загрузка системного промпта
- Генерация промптов через OpenRouter API
- Логируются: topic, количество, размеры запросов/ответов
- Средняя длина сгенерированных промптов

#### Генерация изображений
- **FAL_FLUX**: Flux Pro v1.1 Ultra
- **FAL_IMAGEN4**: Imagen4 Preview
- Логируются: длина промпта, параметры, время генерации, URL результата
- Прогресс из очереди FAL AI

#### Upscale
- **FAL_UPSCALE**: Flux Vision и SeedVR
- Логируются: входной/выходной URL, upscale factor, метод
- Прогресс обработки

#### Метаданные (PIEXIF)
- Встраивание EXIF метаданных через piexifjs (без системных зависимостей)
- Создание JSON sidecar файлов
- Ключевые слова передаются через CSV при SFTP загрузке

#### HTTP Загрузки (DOWNLOAD)
- Скачивание изображений из FAL AI
- Размер файла, скорость загрузки (KB/s)

#### Web API
- **API_TOPICS**: GET/POST запросы к `/api/topics`
- **API_ADOBE**: GET/POST запросы к `/api/adobe-settings`
- **API_TRIGGER**: POST запросы к `/api/trigger-worker` для запуска GitHub Actions workflow
- Логируются: параметры запросов, время выполнения БД операций, статус вызовов GitHub API

### Метрики производительности

Для каждой операции логируются:
- **Время выполнения** (в миллисекундах)
- **Размеры данных** (для файлов и API запросов)
- **Счетчики**: успешные/неудачные операции
- **Контекст**: ID темы, имена файлов, параметры операций

### Обработка ошибок

При ошибках логируются:
- Сообщение об ошибке
- Stack trace (если доступен)
- Контекст операции (параметры, состояние)
- Время до возникновения ошибки

Система продолжает работу даже при неудаче отдельных операций (например, встраивание метаданных).

## Статистика загрузки

### Отслеживание загруженных фотографий

Система автоматически отслеживает и сохраняет информацию о загруженных на Adobe Stock фотографиях:

**В базе данных** (таблица `topics`):
- `uploaded_count` - количество успешно загруженных фотографий
- `uploaded_at` - дата и время последней загрузки

**В Worker** (`main.ts`):
- Подсчитывает успешные загрузки для каждой темы
- Вызывает `updateUploadStats()` перед завершением обработки
- Логирует общее количество загруженных фото

**В Web интерфейсе** (`TopicList.tsx`):
- Показывает количество загруженных фотографий для завершенных тем
- Отображает дату создания темы
- Отображает дату загрузки фотографий
- Визуально выделяет загруженные темы зеленым цветом

### Миграция существующей БД

Для добавления отслеживания в существующую базу данных выполните:
```sql
-- database/migration-add-upload-stats.sql
ALTER TABLE `topics` 
ADD COLUMN `uploaded_count` INT NOT NULL DEFAULT 0,
ADD COLUMN `uploaded_at` DATETIME NULL;
```

